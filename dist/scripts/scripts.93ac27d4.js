"use strict";angular.module("wikiDiverApp",["ngAnimate","ngTagsInput"]),angular.module("wikiDiverApp").controller("MainCtrl",["$scope","$http",function(a,b){a.stopWords=["list of","index of","categories of","portal","disambiguation","outline of"],a.query="",a.regex=/en\.wikipedia\.org\/wiki\//g,a.depth=2,a.qarr=[],a.res=[],a.notFound=[],a.stopped=[],a.download=!1,a.update=function(){a.alert=!1,a.download=!1,a.notFound=[],a.stopped=[],a.res=[],""!==a.query?(a.qarr=a.query.split("\n"),a.qarr.forEach(function(b){console.log("input",JSON.stringify(b));var d=c(b,0,a.res);null===d&&console.log("error")}),a.download=!0):a.alert=!0};var c=function(d,e,f){var g=[],h="",i=/wiki\/(.+)/g,j=null;h=0==e?decodeURIComponent(i.exec(d)[1]):encodeURIComponent(d.name),b.jsonp("http://en.wikipedia.org/w/api.php?action=parse&page="+h+"&prop=sections&format=json&callback=JSON_CALLBACK").success(function(d){if(null===d.parse||!d.parse)return null;var i=d.parse;j=null,i.sections.forEach(function(a){"See also"===a.line&&(j=a.index)}),null!==j?b.jsonp("http://en.wikipedia.org/w/api.php?action=parse&page="+h+"&prop=links&section="+j+"&format=json&disablepp&callback=JSON_CALLBACK").success(function(b){if(b.parse.links.forEach(function(b){var c=!1;a.stopWords.forEach(function(d){b["*"].toLowerCase().indexOf(d)>=0&&(a.stopped.push(b["*"]),c=!0)}),c||g.push({name:b["*"],index:e+1})}),0==e){var d={};d.name=h,d.index=e,d.sons=g,f.push(d)}else f.sons=g;e+1<a.depth&&g.forEach(function(a){a.sons=[],c(a,e+1,a)})}):(console.log("not found: ",h),a.notFound.push(decodeURIComponent(h)))})};a.downloadJSON=function(){var b=angular.toJson(a.res),c=new Blob([b],{type:"data:text/json;charset=utf-8"});saveAs(c,"data.json")}}]),angular.module("wikiDiverApp").controller("AltCtrl",["$scope","$http",function(a,b){a.stopWords=["list of","index of","categories of","portal","disambiguation","outline of"],a.query="";var c=/en\.wikipedia\.org\/wiki\/.+/;a.depth=2,a.qarr=[],a.res=[],a.notFound=[],a.stopped=[],a.edges=[],a.nodes=[],a.update=function(){if(a.alert=!1,a.download=!1,a.notFound=[],a.stopped=[],a.edges=[],a.res=[],console.log(a.stopWords),""!==a.query){var b=!1;a.qarr=a.query.split("\n"),a.qarr.forEach(function(a){c.test(a)||(b=!0)}),b?a.alert=!0:(a.qarr.forEach(function(b){var c=d(b,0,a.res);null===c&&console.log("error")}),a.download=!0)}else a.alert=!0};var d=function(c,f,g){var h=[],i="",j=/wiki\/(.+)/g,k=null;0==f?(i=j.exec(c)[1],a.nodes.push(decodeURIComponent(i).replace(/_/g," "))):i=encodeURIComponent(c.name),b.jsonp("http://en.wikipedia.org/w/api.php?action=parse&page="+i+"&prop=sections&format=json&callback=JSON_CALLBACK").success(function(c){if(null===c.parse||!c.parse)return null;var j=c.parse;k=null,j.sections.forEach(function(a){"See also"===a.line&&(k=a.index)}),null!==k?b.jsonp("http://en.wikipedia.org/w/api.php?format=json&action=query&prop=revisions&titles="+i+"&rvprop=content&rvsection="+k+"&callback=JSON_CALLBACK").success(function(b){var c=e(b);if(c.forEach(function(b){var c=!1;a.stopWords.forEach(function(d){b.toLowerCase().indexOf(d.text)>=0&&(a.stopped.push(b),c=!0)}),c||(-1==a.nodes.indexOf(b)&&a.nodes.push(b),a.edges.push({source:decodeURIComponent(i).replace(/_/g," "),target:b,index:f+1}),h.push({name:b,index:f+1}))}),0==f){var j={};j.name=decodeURIComponent(i).replace(/_/g," "),j.index=f,j.sons=h,g.push(j)}else g.sons=h;f+1<a.depth&&h.forEach(function(a){a.sons=[],d(a,f+1,a)})}):a.notFound.push(decodeURIComponent(i))})},e=function(a){for(var b,c=a.query.pages[Object.keys(a.query.pages)[0]].revisions[0]["*"],d=/\[\[(.*?)\]\]/g,e=[];b=d.exec(c);)e.push(b[1].split("|")[0]);return e};a.downloadJSON=function(){var b=angular.toJson({nodes:a.nodes,edges:a.edges}),c=new Blob([b],{type:"data:text/json;charset=utf-8"});saveAs(c,"data.json")},a.downloadCSV=function(){var b="source	target	depth\n";a.edges.forEach(function(a){b+=a.source+"	"+a.target+"	"+a.index+"\n"});var c=new Blob([b],{type:"data:text/csv;charset=utf-8"});saveAs(c,"data.tsv")}}]);